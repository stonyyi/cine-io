# https://gist.github.com/seldo/9283757
machine:
  pre:
    - npm config set ca ""
  node:
    version: v0.10.28

dependencies:
  pre:
    - gem install iron_worker_ng

machine:
  environment:
    REDIS_PASS: some-password

database:
  pre:
    - echo "requirepass some-password" | sudo tee -a /etc/redis/redis.conf
    - sudo service redis-server restart

deployment:
  production:
    branch: master
    commands:
      - '[[ ! -s "$(git rev-parse --git-dir)/shallow" ]] || git fetch --unshallow'
      - git push git@heroku.com:cine-io.git $CIRCLE_SHA1:refs/heads/master
      - coffee script/smoke_test.coffee
      - (cd worker; iron_worker upload main_worker):
          timeout: 600
